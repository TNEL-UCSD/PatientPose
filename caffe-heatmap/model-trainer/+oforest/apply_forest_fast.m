%function to apply forest to a frame
%interlaces the application of trees on every other pixel, this gives a
%theoretical speed increase of x2
function [locs,dist,conf,leafids] = apply_forest_fast(omodel,frame,bbox,islocs_needed)
    %check for correct padding
    omodel.opts.model.windowwidth  = max(omodel.opts.model.windows.widths);
    omodel.opts.model.padding = ceil(omodel.opts.model.windowwidth/2) + 1;
    
    if ~exist('islocs_needed','var')
        islocs_needed = true;
    end
    
    bbox(1) = bbox(1) + omodel.opts.model.padding;
    bbox(2) = bbox(2) + omodel.opts.model.padding;
    conf = zeros(1,omodel.opts.model.numclasses-1);
    
    frame_pad = padarray(frame,[omodel.opts.model.padding omodel.opts.model.padding],0,'both');
    if islocs_needed
        dist = zeros(bbox(4)*bbox(3),omodel.opts.model.numclasses);
    else
        dist = [];
    end
    leafids = zeros(bbox(4),bbox(3),numel(omodel.forestmat));
    
    interlace_even = 1;
    for f = 1:numel(omodel.forestmat);
        [tempdist,templeafid] = mxclassify_fast(omodel.opts.model.numchannels,...
            bbox(1),bbox(2),bbox(3),bbox(4),...
            double(omodel.forestmat{f}),double(frame_pad),...
            omodel.opts.model.numclasses,interlace_even);
        leafids(:,:,f) = reshape(templeafid,bbox(4),bbox(3));
        if islocs_needed
            dist = dist + tempdist;
        end
        
        if interlace_even == 1
            interlace_even = 0;
        else
            interlace_even = 1;
        end
    end
    
    locs = zeros(2,omodel.opts.model.numclasses-1);
    
    if islocs_needed 
        %Gaussian filter
        filt = [2.57201416647233e-06,5.11506094515999e-06,9.55619193281460e-06,1.67716391544927e-05,2.76517582185192e-05,4.28278809393480e-05,6.23141990730418e-05,8.51734115668906e-05,0.000109364825277893,0.000131919160472835,0.000149483992619667,0.000159124881840554,0.000159124881840554,0.000149483992619667,0.000131919160472835,0.000109364825277893,8.51734115668906e-05,6.23141990730418e-05,4.28278809393480e-05,2.76517582185192e-05,1.67716391544927e-05,9.55619193281460e-06,5.11506094515999e-06,2.57201416647233e-06;5.11506094515999e-06,1.01725133608367e-05,1.90047569633084e-05,3.33543872128531e-05,5.49920876689993e-05,8.51734115668906e-05,0.000123926582583568,0.000169387554995229,0.000217497925884467,0.000262352577388166,0.000297284417225495,0.000316457614859165,0.000316457614859165,0.000297284417225495,0.000262352577388166,0.000217497925884467,0.000169387554995229,0.000123926582583568,8.51734115668906e-05,5.49920876689993e-05,3.33543872128531e-05,1.90047569633084e-05,1.01725133608367e-05,5.11506094515999e-06;9.55619193281460e-06,1.90047569633084e-05,3.55055603686828e-05,6.23141990730418e-05,0.000102738745478366,0.000159124881840554,0.000231525336930142,0.000316457614859165,0.000406339620783548,0.000490139142127366,0.000555400410689126,0.000591220659659278,0.000591220659659278,0.000555400410689126,0.000490139142127366,0.000406339620783548,0.000316457614859165,0.000231525336930142,0.000159124881840554,0.000102738745478366,6.23141990730418e-05,3.55055603686828e-05,1.90047569633084e-05,9.55619193281460e-06;1.67716391544927e-05,3.33543872128531e-05,6.23141990730418e-05,0.000109364825277893,0.000180312113702065,0.000279272864912522,0.000406339620783548,0.000555400410689126,0.000713148243763648,0.000860220983949159,0.000974758077257613,0.00103762457202616,0.00103762457202616,0.000974758077257613,0.000860220983949159,0.000713148243763648,0.000555400410689126,0.000406339620783548,0.000279272864912522,0.000180312113702065,0.000109364825277893,6.23141990730418e-05,3.33543872128531e-05,1.67716391544927e-05;2.76517582185192e-05,5.49920876689993e-05,0.000102738745478366,0.000180312113702065,0.000297284417225495,0.000460443112710638,0.000669940775914059,0.000915700470858749,0.00117578267865557,0.00141826463373957,0.00160710437576138,0.00171075370290064,0.00171075370290064,0.00160710437576138,0.00141826463373957,0.00117578267865557,0.000915700470858749,0.000669940775914059,0.000460443112710638,0.000297284417225495,0.000180312113702065,0.000102738745478366,5.49920876689993e-05,2.76517582185192e-05;4.28278809393480e-05,8.51734115668906e-05,0.000159124881840554,0.000279272864912522,0.000460443112710638,0.000713148243763648,0.00103762457202616,0.00141826463373957,0.00182108783731094,0.00219665123621709,0.00248913195024673,0.00264966716855305,0.00264966716855305,0.00248913195024673,0.00219665123621709,0.00182108783731094,0.00141826463373957,0.00103762457202616,0.000713148243763648,0.000460443112710638,0.000279272864912522,0.000159124881840554,8.51734115668906e-05,4.28278809393480e-05;6.23141990730418e-05,0.000123926582583568,0.000231525336930142,0.000406339620783548,0.000669940775914059,0.00103762457202616,0.00150973484389494,0.00206356286574771,0.00264966716855305,0.00319610868960633,0.00362166561746085,0.00385524298184040,0.00385524298184040,0.00362166561746085,0.00319610868960633,0.00264966716855305,0.00206356286574771,0.00150973484389494,0.00103762457202616,0.000669940775914059,0.000406339620783548,0.000231525336930142,0.000123926582583568,6.23141990730418e-05;8.51734115668906e-05,0.000169387554995229,0.000316457614859165,0.000555400410689126,0.000915700470858749,0.00141826463373957,0.00206356286574771,0.00282055601890129,0.00362166561746085,0.00436856262106919,0.00495022997619011,0.00526949238002346,0.00526949238002346,0.00495022997619011,0.00436856262106919,0.00362166561746085,0.00282055601890129,0.00206356286574771,0.00141826463373957,0.000915700470858749,0.000555400410689126,0.000316457614859165,0.000169387554995229,8.51734115668906e-05;0.000109364825277893,0.000217497925884467,0.000406339620783548,0.000713148243763648,0.00117578267865557,0.00182108783731094,0.00264966716855305,0.00362166561746085,0.00465031070356383,0.00560934543984486,0.00635622110787766,0.00676616214899250,0.00676616214899250,0.00635622110787766,0.00560934543984486,0.00465031070356383,0.00362166561746085,0.00264966716855305,0.00182108783731094,0.00117578267865557,0.000713148243763648,0.000406339620783548,0.000217497925884467,0.000109364825277893;0.000131919160472835,0.000262352577388166,0.000490139142127366,0.000860220983949159,0.00141826463373957,0.00219665123621709,0.00319610868960633,0.00436856262106919,0.00560934543984486,0.00676616214899250,0.00766706617233017,0.00816154945660203,0.00816154945660203,0.00766706617233017,0.00676616214899250,0.00560934543984486,0.00436856262106919,0.00319610868960633,0.00219665123621709,0.00141826463373957,0.000860220983949159,0.000490139142127366,0.000262352577388166,0.000131919160472835;0.000149483992619667,0.000297284417225495,0.000555400410689126,0.000974758077257613,0.00160710437576138,0.00248913195024673,0.00362166561746085,0.00495022997619011,0.00635622110787766,0.00766706617233017,0.00868792417273693,0.00924824714137698,0.00924824714137698,0.00868792417273693,0.00766706617233017,0.00635622110787766,0.00495022997619011,0.00362166561746085,0.00248913195024673,0.00160710437576138,0.000974758077257613,0.000555400410689126,0.000297284417225495,0.000149483992619667;0.000159124881840554,0.000316457614859165,0.000591220659659278,0.00103762457202616,0.00171075370290064,0.00264966716855305,0.00385524298184040,0.00526949238002346,0.00676616214899250,0.00816154945660203,0.00924824714137698,0.00984470783669873,0.00984470783669873,0.00924824714137698,0.00816154945660203,0.00676616214899250,0.00526949238002346,0.00385524298184040,0.00264966716855305,0.00171075370290064,0.00103762457202616,0.000591220659659278,0.000316457614859165,0.000159124881840554;0.000159124881840554,0.000316457614859165,0.000591220659659278,0.00103762457202616,0.00171075370290064,0.00264966716855305,0.00385524298184040,0.00526949238002346,0.00676616214899250,0.00816154945660203,0.00924824714137698,0.00984470783669873,0.00984470783669873,0.00924824714137698,0.00816154945660203,0.00676616214899250,0.00526949238002346,0.00385524298184040,0.00264966716855305,0.00171075370290064,0.00103762457202616,0.000591220659659278,0.000316457614859165,0.000159124881840554;0.000149483992619667,0.000297284417225495,0.000555400410689126,0.000974758077257613,0.00160710437576138,0.00248913195024673,0.00362166561746085,0.00495022997619011,0.00635622110787766,0.00766706617233017,0.00868792417273693,0.00924824714137698,0.00924824714137698,0.00868792417273693,0.00766706617233017,0.00635622110787766,0.00495022997619011,0.00362166561746085,0.00248913195024673,0.00160710437576138,0.000974758077257613,0.000555400410689126,0.000297284417225495,0.000149483992619667;0.000131919160472835,0.000262352577388166,0.000490139142127366,0.000860220983949159,0.00141826463373957,0.00219665123621709,0.00319610868960633,0.00436856262106919,0.00560934543984486,0.00676616214899250,0.00766706617233017,0.00816154945660203,0.00816154945660203,0.00766706617233017,0.00676616214899250,0.00560934543984486,0.00436856262106919,0.00319610868960633,0.00219665123621709,0.00141826463373957,0.000860220983949159,0.000490139142127366,0.000262352577388166,0.000131919160472835;0.000109364825277893,0.000217497925884467,0.000406339620783548,0.000713148243763648,0.00117578267865557,0.00182108783731094,0.00264966716855305,0.00362166561746085,0.00465031070356383,0.00560934543984486,0.00635622110787766,0.00676616214899250,0.00676616214899250,0.00635622110787766,0.00560934543984486,0.00465031070356383,0.00362166561746085,0.00264966716855305,0.00182108783731094,0.00117578267865557,0.000713148243763648,0.000406339620783548,0.000217497925884467,0.000109364825277893;8.51734115668906e-05,0.000169387554995229,0.000316457614859165,0.000555400410689126,0.000915700470858749,0.00141826463373957,0.00206356286574771,0.00282055601890129,0.00362166561746085,0.00436856262106919,0.00495022997619011,0.00526949238002346,0.00526949238002346,0.00495022997619011,0.00436856262106919,0.00362166561746085,0.00282055601890129,0.00206356286574771,0.00141826463373957,0.000915700470858749,0.000555400410689126,0.000316457614859165,0.000169387554995229,8.51734115668906e-05;6.23141990730418e-05,0.000123926582583568,0.000231525336930142,0.000406339620783548,0.000669940775914059,0.00103762457202616,0.00150973484389494,0.00206356286574771,0.00264966716855305,0.00319610868960633,0.00362166561746085,0.00385524298184040,0.00385524298184040,0.00362166561746085,0.00319610868960633,0.00264966716855305,0.00206356286574771,0.00150973484389494,0.00103762457202616,0.000669940775914059,0.000406339620783548,0.000231525336930142,0.000123926582583568,6.23141990730418e-05;4.28278809393480e-05,8.51734115668906e-05,0.000159124881840554,0.000279272864912522,0.000460443112710638,0.000713148243763648,0.00103762457202616,0.00141826463373957,0.00182108783731094,0.00219665123621709,0.00248913195024673,0.00264966716855305,0.00264966716855305,0.00248913195024673,0.00219665123621709,0.00182108783731094,0.00141826463373957,0.00103762457202616,0.000713148243763648,0.000460443112710638,0.000279272864912522,0.000159124881840554,8.51734115668906e-05,4.28278809393480e-05;2.76517582185192e-05,5.49920876689993e-05,0.000102738745478366,0.000180312113702065,0.000297284417225495,0.000460443112710638,0.000669940775914059,0.000915700470858749,0.00117578267865557,0.00141826463373957,0.00160710437576138,0.00171075370290064,0.00171075370290064,0.00160710437576138,0.00141826463373957,0.00117578267865557,0.000915700470858749,0.000669940775914059,0.000460443112710638,0.000297284417225495,0.000180312113702065,0.000102738745478366,5.49920876689993e-05,2.76517582185192e-05;1.67716391544927e-05,3.33543872128531e-05,6.23141990730418e-05,0.000109364825277893,0.000180312113702065,0.000279272864912522,0.000406339620783548,0.000555400410689126,0.000713148243763648,0.000860220983949159,0.000974758077257613,0.00103762457202616,0.00103762457202616,0.000974758077257613,0.000860220983949159,0.000713148243763648,0.000555400410689126,0.000406339620783548,0.000279272864912522,0.000180312113702065,0.000109364825277893,6.23141990730418e-05,3.33543872128531e-05,1.67716391544927e-05;9.55619193281460e-06,1.90047569633084e-05,3.55055603686828e-05,6.23141990730418e-05,0.000102738745478366,0.000159124881840554,0.000231525336930142,0.000316457614859165,0.000406339620783548,0.000490139142127366,0.000555400410689126,0.000591220659659278,0.000591220659659278,0.000555400410689126,0.000490139142127366,0.000406339620783548,0.000316457614859165,0.000231525336930142,0.000159124881840554,0.000102738745478366,6.23141990730418e-05,3.55055603686828e-05,1.90047569633084e-05,9.55619193281460e-06;5.11506094515999e-06,1.01725133608367e-05,1.90047569633084e-05,3.33543872128531e-05,5.49920876689993e-05,8.51734115668906e-05,0.000123926582583568,0.000169387554995229,0.000217497925884467,0.000262352577388166,0.000297284417225495,0.000316457614859165,0.000316457614859165,0.000297284417225495,0.000262352577388166,0.000217497925884467,0.000169387554995229,0.000123926582583568,8.51734115668906e-05,5.49920876689993e-05,3.33543872128531e-05,1.90047569633084e-05,1.01725133608367e-05,5.11506094515999e-06;2.57201416647233e-06,5.11506094515999e-06,9.55619193281460e-06,1.67716391544927e-05,2.76517582185192e-05,4.28278809393480e-05,6.23141990730418e-05,8.51734115668906e-05,0.000109364825277893,0.000131919160472835,0.000149483992619667,0.000159124881840554,0.000159124881840554,0.000149483992619667,0.000131919160472835,0.000109364825277893,8.51734115668906e-05,6.23141990730418e-05,4.28278809393480e-05,2.76517582185192e-05,1.67716391544927e-05,9.55619193281460e-06,5.11506094515999e-06,2.57201416647233e-06];
        dist = reshape(dist,[bbox(4),bbox(3),omodel.opts.model.numclasses]);
        dist = imfilter(dist,filt,0)/(numel(omodel.forestmat)/2);

        if isfield(omodel,'prior')
             dist = bsxfun(@rdivide,dist,eps+sum(sum(dist)));
            dist = (dist(:,:,1:(omodel.opts.model.numclasses-1))+0.0001).*omodel.prior;
        end

    
        for c = 1:(omodel.opts.model.numclasses-1)
            [my, idxy]= max(dist(:,:,c)); %take point of maximum confidence
            [mx,x] = max(my);

            y = idxy(x);
            locs(:,c) = [x; y];
            conf(c) = mx;
        end

        locs = bsxfun(@plus,locs,[bbox(1);bbox(2)]-1-omodel.opts.model.padding);
    end